<!DOCTYPE html>
<html>
  <head>
    <title>訂餐表</title>
    <base target="_top"> 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/amazeui/2.7.2/css/amazeui.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/amazeui/2.7.2/js/amazeui.min.js"></script>  
    
    <!-- 修正.am-radio的錯誤margin -->
    <style>
      .am-radio input[type=radio]{
        margin-left:0px;
        margin-top:0px;
      }
    </style>
    
    <script>
    
      function load(){
        /* 刷新當前時間 */
        showTime();
        
        /* 提交訂餐選項 */
        $('#btn-submitOrder').click(submitOrder);
        }
        
        /* 獲取用戶信息 */
        google.script.run
          .withSuccessHandler(showUserInfo)
          .withFailureHandler(function (error) {
            if( error.message == "#ERR_NOTFOUND" )
              $("#userInfo").text("請使用個人郵箱登陸再訂餐！");
            else
              $("#userInfo").text("ERROR: " + error.message);
            $('#userInfo').fadeIn("slow");
            })
          .getUserInfo();
          
        function showUserInfo(info) {       
          $("#userInfo").html( 
            "<p><strong>當前用戶信息：</strong></p>" + 
            "<table class=\"am-table am-table-radius am-table-bordered am-table-centered am-table-compact\">" +  
            "<tr><th>事業部</th><th>部門</th><th>姓名</th></tr>" + 
            "<tr><td>" + info.division + 
            "</td><td>" + info.department + 
            "</td><td id=\"name\">" + info.name + 
            "</td></tr></table>");
          $('#userInfo').fadeIn("slow");
          
          /* 填充訂餐日期及菜單 */
          google.script.run
            .withSuccessHandler(showDateAndMenu)
            .withFailureHandler(function (error) {
              alert("ERROR: " + error.message);
              })
            .getFormatedDateAndMenu(info.name);
        } 
          
        function showDateAndMenu(formatedDateAndMenu) {
          for( var key = 0, i = 1; key < 6; key++, i++ )
          {
            var haveSelection = false;
            $("#date" + i).text(formatedDateAndMenu[key][0] + " " + formatedDateAndMenu[key][1]);
            for( var col = 2; col < 7; col++ )
            {
              if( formatedDateAndMenu[key][col] == "休" )//休息日
              {
                $("#day" + i + "menu" + (col - 1)).text("休息不点餐~");
                $("#day" + i + "menu" + (col - 1)).attr('class','am-text-warning');
                $("#day" + i + "value" + (col - 1)).attr("value","false");
                $("#day" + i + "value" + (col - 1)).uCheck('disable');
                continue;
              }
              else if( formatedDateAndMenu[key][col] == "" )//菜式為空白
              {
                $("#day" + i + "menu" + (col - 1)).text("敬請期待~");
                $("#day" + i + "menu" + (col - 1)).attr('class','am-text-warning');
                $("#day" + i + "value" + (col - 1)).attr("value","false");
                $("#day" + i + "value" + (col - 1)).uCheck('disable');
                continue;
              }
              else if( eval(formatedDateAndMenu[key][col + 5]) <= eval(formatedDateAndMenu[key][col + 10]) )//已定滿
              {
                if( formatedDateAndMenu[key][col] == formatedDateAndMenu[key][17] )//訂滿項為已選項
                {
                  $("#day" + i + "menu" + (col - 1)).html("<strong>"+formatedDateAndMenu[key][col]+"</strong>");
                  $("#day" + i + "menu" + (col - 1)).attr('class','am-text-success am-text-lg');
                  $("#day" + i + "value" + (col - 1)).attr("value",(col - 1) + formatedDateAndMenu[key][col]);
                  $("#day" + i + "value" + (col - 1)).uCheck('check');
                  haveSelection = true;
                  continue;
                }
                else//訂滿項不是已選項
                {
                  $("#day" + i + "menu" + (col - 1)).text("訂滿了~明日請早！");
                  $("#day" + i + "menu" + (col - 1)).attr('class','am-text-warning');
                  $("#day" + i + "value" + (col - 1)).attr("value","false");
                  $("#day" + i + "value" + (col - 1)).uCheck('disable');
                  continue;
                }
              }
              else//可選且不為已選項
              {
                $("#day" + i + "menu" + (col - 1)).html("<strong>"+formatedDateAndMenu[key][col]+"</strong>");
                //$("#day" + i + "menu" + (col - 1)).text(formatedDateAndMenu[key][col]);
                $("#day" + i + "menu" + (col - 1)).attr('class','am-text-success am-text-lg');
                $("#day" + i + "value" + (col - 1)).attr("value",(col - 1) + formatedDateAndMenu[key][col]);
                
                if( formatedDateAndMenu[key][col] == formatedDateAndMenu[key][17] )//可選且為已選項
                {
                  $("#day" + i + "value" + (col - 1)).uCheck('check');
                  haveSelection = true;
                }
              }
            }
            //默認選擇不訂
            if( !haveSelection ) $("#day" + i + "value0").uCheck('check');
          }
          $('#menuGroup').fadeIn("slow");
          $('#btn-submitOrder').removeClass("am-disabled");
          $('#btn-submitOrder').fadeIn("slow");
        }
      
      /* 提交訂餐選項 */
        function submitOrder(){
          try{
            $(':radio').uCheck('disable');
            var $btn = $(this);
            $btn.button('loading');
            
            var orderResult = [];
            orderResult.push($("#name").text());
            for( var day = 1; day < 7; day++ )
            {
              orderResult.push($("input[name='day" + day + "ord']:checked").val());     
            }
            
            google.script.run
              .withSuccessHandler(submitSuccess)
              .withFailureHandler(submitFailed)
              .submitOrder(orderResult);
              
            setTimeout(function(){
              $btn.button('reset');
            }, 500);
          }
          catch(e){
            alert(e.toString());
          }
        }
      
      /* 訂餐成功顯示信息并更新radio */
        function submitSuccess() {
          $("#ordresult").text("訂餐成功");
          $("#ordresult").fadeIn("fast");
          $("input[value!='false']").uCheck('enable');
          
          setTimeout(function(){
            $("#ordresult").fadeOut("slow");
          }, 5000);
        }
      
      /* 訂餐失敗顯示信息并更新radio */
        function submitFailed(error) {
          $("#ordresult").text("訂餐失敗，聽我解釋："+error.message);
          $("#ordresult").fadeIn("slow");
          $("input[value!='false']").uCheck('enable');
          
          setTimeout(function(){
            $("#ordresult").fadeOut("slow");
          }, 5000);
        }
      
      /* 刷新當前時間 */
        function showTime(){
          var today = new Date();
          var year = today.getFullYear(),
              month = (today.getMonth() + 1),
              day = today.getDate(),
              hours = today.getHours(),
              minutes = today.getMinutes(),
              seconds = today.getSeconds();
              
          month = checkTime(month);
          day = checkTime(day);
          minutes = checkTime(minutes);
          seconds = checkTime(seconds);
          $("#time").html("<h2>當前時間: " + year + "年" + month + "月" + day + "日 " + hours + ":" + minutes + ":" + seconds + "</h2>");
          
          t = setTimeout(function(){showTime()},1000);
        }
        
        function checkTime(i){
          if (i<10) i="0" + i;
          return i;
        }

    </script>
  </head>
  
  <body onload="load()">
    <div id="time">Time Loading...</div>
    <div id="userInfo" style="display:none;">Loading...</div>
    
    <div id="menuGroup" style="display:none;">
      <table class="am-table am-text-left am-table-compact am-text-lg">
        <tr>
          <td id="day1">
            <div class="am-g">
                <h3 id="date1">Date Loading...</h3>
                <label class="am-radio am-success">
                  <input type="radio" name="day1ord" value="0none" id="day1value0" data-am-ucheck>
                  <span id="day1menu0">不訂</span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day1ord" value="" id="day1value1" data-am-ucheck>
                  <span id="day1menu1"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day1ord" value="" id="day1value2" data-am-ucheck>
                  <span id="day1menu2"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day1ord" value="" id="day1value3" data-am-ucheck>
                  <span id="day1menu3"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day1ord" value="" id="day1value4" data-am-ucheck>
                  <span id="day1menu4"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day1ord" value="" id="day1value5" data-am-ucheck >
                  <span id="day1menu5"></span>
                </label>
            </div>
          </td>
          <td id="day2">
            <div class="am-g">
                <h3 id="date2">Date Loading...</h3>
                <label class="am-radio am-success">
                  <input type="radio" name="day2ord" value="0none" id="day2value0" data-am-ucheck>
                  <span id="day2menu0">不訂</span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day2ord" value="" id="day2value1" data-am-ucheck>
                  <span id="day2menu1"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day2ord" value="" id="day2value2" data-am-ucheck>
                  <span id="day2menu2"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day2ord" value="" id="day2value3" data-am-ucheck>
                  <span id="day2menu3"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day2ord" value="" id="day2value4" data-am-ucheck>
                  <span id="day2menu4"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day2ord" value="" id="day2value5" data-am-ucheck>
                  <span id="day2menu5"></span>
                </label>
            </div>
          </td>
          <td id="day3">
            <div class="am-g">
                <h3 id="date3">Date Loading...</h3>
                <label class="am-radio am-success">
                  <input type="radio" name="day3ord" value="0none" id="day3value0" data-am-ucheck>
                  <span id="day3menu0">不訂</span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day3ord" value="" id="day3value1" data-am-ucheck>
                  <span id="day3menu1"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day3ord" value="" id="day3value2" data-am-ucheck>
                  <span id="day3menu2"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day3ord" value="" id="day3value3" data-am-ucheck>
                  <span id="day3menu3"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day3ord" value="" id="day3value4" data-am-ucheck>
                  <span id="day3menu4"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day3ord" value="" id="day3value5" data-am-ucheck>
                  <span id="day3menu5"></span>
                </label>
            </div>
          </td>
        </tr>
        
        <tr>         
          <td id="day4">
            <div class="am-g">
                <h3 id="date4">Date Loading...</h3>
                <label class="am-radio am-success">
                  <input type="radio" name="day4ord" value="0none" id="day4value0" data-am-ucheck>
                  <span id="day4menu0">不訂</span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day4ord" value="" id="day4value1" data-am-ucheck>
                  <span id="day4menu1"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day4ord" value="" id="day4value2" data-am-ucheck>
                  <span id="day4menu2"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day4ord" value="" id="day4value3" data-am-ucheck>
                  <span id="day4menu3"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day4ord" value="" id="day4value4" data-am-ucheck>
                  <span id="day4menu4"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day4ord" value="" id="day4value5" data-am-ucheck>
                  <span id="day4menu5"></span>
                </label>
            </div>
          </td>
          <td id="day5">
            <div class="am-g">
                <h3 id="date5">Date Loading...</h3>
                <label class="am-radio am-success">
                  <input type="radio" name="day5ord" value="0none" id="day5value0" data-am-ucheck>
                  <span id="day5menu0">不訂</span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day5ord" value="" id="day5value1" data-am-ucheck>
                  <span id="day5menu1"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day5ord" value="" id="day5value2" data-am-ucheck>
                  <span id="day5menu2"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day5ord" value="" id="day5value3" data-am-ucheck>
                  <span id="day5menu3"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day5ord" value="" id="day5value4" data-am-ucheck>
                  <span id="day5menu4"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day5ord" value="" id="day5value5" data-am-ucheck>
                  <span id="day5menu5"></span>
                </label>
            </div>
          </td>
          <td id="day6">
            <div class="am-g">
                <h3 id="date6">Date Loading...</h3>
                <label class="am-radio am-success">
                  <input type="radio" name="day6ord" value="0none" id="day6value0" data-am-ucheck>
                  <span id="day6menu0">不訂</span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day6ord" value="" id="day6value1" data-am-ucheck>
                  <span id="day6menu1"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day6ord" value="" id="day6value2" data-am-ucheck>
                  <span id="day6menu2"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day6ord" value="" id="day6value3" data-am-ucheck>
                  <span id="day6menu3"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day6ord" value="" id="day6value4" data-am-ucheck>
                  <span id="day6menu4"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day6ord" value="" id="day6value5" data-am-ucheck>
                  <span id="day6menu5"></span>
                </label>
            </div>
          </td>
        </tr>

      </table>
    </div>
 
    <button type="button" class="am-btn am-btn-success am-radius am-btn-block am-disabled" 
            data-am-loading="{spinner: 'spinner', loadingText: '努力訂餐中...', resetText: '確定訂餐'}"
            style="display:none;"
            id="btn-submitOrder">
            確定訂餐
    </button>
    
    <div id="ordresult" class="am-text-center am-text-default"></div>
  </body>
</html>