<!DOCTYPE html>
<html>
  <head>
    <title>訂餐表</title>
    <base target="_top"> 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/amazeui/2.7.2/css/amazeui.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/amazeui/2.7.2/js/amazeui.min.js"></script>
      <style>
      hr{
        margin:10px;
      }
  </style>
  </head>

  <body onload="load()">
    <!-- 刷新當前時間 -->
    <div id="time" class="am-text-center">Time Loading...</div>
    <hr />
    
    <!-- 加載用戶信息 -->
    <div id="userInfo" style="display:none;width:400px;" class="am-container">
      <div class="am-g am-text-center">
        <div class="am-u-sm-4">事業部</div>
        <div class="am-u-sm-4">部門</div>
        <div class="am-u-sm-4">姓名</div>
      </div>
      <div class="am-g am-text-center">
        <div class="am-u-sm-4" id="division"></div>
        <div class="am-u-sm-4" id="department"></div>
        <div class="am-u-sm-4" id="name"></div>
      </div>
    </div>
    <hr />
    <div id="ordresult"></div>
    <!-- 加載菜單信息 -->
    <div id="menuGroup" style="display:none;">
      <div class="am-g">
          <!-- day1 -->
          <div class="am-u-lg-4" id="day1">
            <h2 id="date1"></h2>
                <label class="am-radio am-success">
                  <input type="radio" name="day1ord" value="0none" id="day1value0" data-am-ucheck>
                  <span id="day1menu0">不訂</span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day1ord" value="" id="day1value1" data-am-ucheck>
                  <span id="day1menu1"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day1ord" value="" id="day1value2" data-am-ucheck>
                  <span id="day1menu2"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day1ord" value="" id="day1value3" data-am-ucheck>
                  <span id="day1menu3"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day1ord" value="" id="day1value4" data-am-ucheck>
                  <span id="day1menu4"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day1ord" value="" id="day1value5" data-am-ucheck >
                  <span id="day1menu5"></span>
                </label>
          </div>
          <!-- day1end -->
          <!-- day2 -->
          <div class="am-u-lg-4" id="day2">
              <h2 id="date2"></h2>
                <label class="am-radio am-success">
                  <input type="radio" name="day2ord" value="0none" id="day2value0" data-am-ucheck>
                  <span id="day2menu0">不訂</span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day2ord" value="" id="day2value1" data-am-ucheck>
                  <span id="day2menu1"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day2ord" value="" id="day2value2" data-am-ucheck>
                  <span id="day2menu2"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day2ord" value="" id="day2value3" data-am-ucheck>
                  <span id="day2menu3"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day2ord" value="" id="day2value4" data-am-ucheck>
                  <span id="day2menu4"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day2ord" value="" id="day2value5" data-am-ucheck>
                  <span id="day2menu5"></span>
                </label>
          </div>
          <!-- day2end -->
          <!-- day3 -->
          <div class="am-u-lg-4" id="day3">
              <h2 id="date3"></h2>
                <label class="am-radio am-success">
                  <input type="radio" name="day3ord" value="0none" id="day3value0" data-am-ucheck>
                  <span id="day3menu0">不訂</span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day3ord" value="" id="day3value1" data-am-ucheck>
                  <span id="day3menu1"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day3ord" value="" id="day3value2" data-am-ucheck>
                  <span id="day3menu2"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day3ord" value="" id="day3value3" data-am-ucheck>
                  <span id="day3menu3"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day3ord" value="" id="day3value4" data-am-ucheck>
                  <span id="day3menu4"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day3ord" value="" id="day3value5" data-am-ucheck>
                  <span id="day3menu5"></span>
                </label>
          </div>
          <!-- day3end -->
        </div>
        
      <div class="am-g">  
          <!-- day4 -->
          <div class="am-u-lg-4" id="day4">
              <h2 id="date4"></h2>
                <label class="am-radio am-success">
                  <input type="radio" name="day4ord" value="0none" id="day4value0" data-am-ucheck>
                  <span id="day4menu0">不訂</span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day4ord" value="" id="day4value1" data-am-ucheck>
                  <span id="day4menu1"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day4ord" value="" id="day4value2" data-am-ucheck>
                  <span id="day4menu2"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day4ord" value="" id="day4value3" data-am-ucheck>
                  <span id="day4menu3"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day4ord" value="" id="day4value4" data-am-ucheck>
                  <span id="day4menu4"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day4ord" value="" id="day4value5" data-am-ucheck>
                  <span id="day4menu5"></span>
                </label>
          </div>
          <!-- day4end -->
          <!-- day5 -->
          <div class="am-u-lg-4" id="day5">
              <h2 id="date5"></h2>
                <label class="am-radio am-success">
                  <input type="radio" name="day5ord" value="0none" id="day5value0" data-am-ucheck>
                  <span id="day5menu0">不訂</span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day5ord" value="" id="day5value1" data-am-ucheck>
                  <span id="day5menu1"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day5ord" value="" id="day5value2" data-am-ucheck>
                  <span id="day5menu2"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day5ord" value="" id="day5value3" data-am-ucheck>
                  <span id="day5menu3"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day5ord" value="" id="day5value4" data-am-ucheck>
                  <span id="day5menu4"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day5ord" value="" id="day5value5" data-am-ucheck>
                  <span id="day5menu5"></span>
                </label>
          </div>
          <!-- day5end -->
          <!-- day6 -->
          <div class="am-u-lg-4" id="day6">
              <h2 id="date6"></h2>
                <label class="am-radio am-success">
                  <input type="radio" name="day6ord" value="0none" id="day6value0" data-am-ucheck>
                  <span id="day6menu0">不訂</span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day6ord" value="" id="day6value1" data-am-ucheck>
                  <span id="day6menu1"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day6ord" value="" id="day6value2" data-am-ucheck>
                  <span id="day6menu2"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day6ord" value="" id="day6value3" data-am-ucheck>
                  <span id="day6menu3"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day6ord" value="" id="day6value4" data-am-ucheck>
                  <span id="day6menu4"></span>
                </label>
                <label class="am-radio am-success">
                  <input type="radio" name="day6ord" value="" id="day6value5" data-am-ucheck>
                  <span id="day6menu5"></span>
                </label>
          </div>
          <!-- day6end -->
      </div>    
    </div>
    
    <button type="button" class="am-btn am-btn-success am-radius am-btn-block am-disabled" 
            data-am-loading="{spinner: 'spinner', loadingText: '已經在努力訂餐了...', resetText: '我要再訂'}"
            style="display:none;"
            id="btn-submitOrder">
            確定訂餐
    </button>
    
    
    
  </body>
</html>



<script>
      function load(){
        /* 刷新當前時間 */
        showTime();
        
        /* 提交訂餐選項 */
        $('#btn-submitOrder').click(submitOrder);
        }
        
        /* 獲取用戶信息 */
        google.script.run
          .withSuccessHandler(showUserInfo)
          .withFailureHandler(function (error) {
            if( error.message == "#ERR_NOTFOUND" )
              $("#userInfo").text("請使用個人郵箱登陸再訂餐！");
            else
              $("#userInfo").text("ERROR: " + error.message);
              $("#userInfo").attr('style','display:none;');
              $('#userInfo').fadeIn("slow");
            })
          .getUserInfo();
          
        function showUserInfo(info) {       
          $("#division").html("<strong>"+info.division+"</strong>");
          $("#department").html("<strong>"+info.department+"</strong>");
          $("#name").html("<strong>"+info.name+"</strong>");
          $('#userInfo').fadeIn("slow");
          
          /* 填充訂餐日期及菜單 */
          refreshMenu();
        } 
        
        /* 填充訂餐日期及菜單 */
        function refreshMenu() {
          google.script.run
            .withSuccessHandler(showDateAndMenu)
            .withFailureHandler(function (error) {
                $("#menuGroup").text("ERROR: " + error.message);
                $('#menuGroup').fadeIn("slow");
              })
            .getFormatedDateAndMenu($("#name").text());
        }
          
        function showDateAndMenu(formatedDateAndMenu) {
          for( var key = 0, i = 1; key < 6; key++, i++ )
          {
            /* 當天是否有已選項 */
            var haveSelection = false;
            /* 加載日期 */
            $("#date" + i).text(formatedDateAndMenu[key][0] + " " + formatedDateAndMenu[key][1]);
            for( var col = 2; col < 7; col++ )
            {
              /* 當前菜式 */
              var menu = formatedDateAndMenu[key][col];
              /* 當前菜式總數 */
              var menuTotal = formatedDateAndMenu[key][col + 5];
              /* 當前菜式已訂數 */
              var menuNow = formatedDateAndMenu[key][col + 10];
              /* 已選菜式 */
              var menuSelected = formatedDateAndMenu[key][17];
              
              /* 休息日 */
              if( menu == "休" )
              {
                $("#day" + i + "menu" + (col - 1)).text("休息不点餐~");
                $("#day" + i + "menu" + (col - 1)).attr('class','am-text-default');
                $("#day" + i + "value" + (col - 1)).attr("value","false");
                $("#day" + i + "value" + (col - 1)).uCheck('disable');
                continue;
              }
              /* 菜式為空白 */
              else if( menu == "" )
              {
                $("#day" + i + "menu" + (col - 1)).text("敬請期待~");
                $("#day" + i + "menu" + (col - 1)).attr('class','am-text-default');
                $("#day" + i + "value" + (col - 1)).attr("value","false");
                $("#day" + i + "value" + (col - 1)).uCheck('disable');
                continue;
              }
              /* 已訂滿 */
              else if( eval(menuTotal) <= eval(menuNow) )
              {
                /* 訂滿項為已選項 */
                if( menu == menuSelected )
                {
                  $("#day" + i + "menu" + (col - 1)).html("<strong>" + menu + "(" + menuNow + "/" + menuTotal + ")" + "</strong>");
                  $("#day" + i + "menu" + (col - 1)).attr('class','am-text-warning am-text-lg');
                  $("#day" + i + "value" + (col - 1)).attr("value",(col - 1) + menu);
                  $("#day" + i + "value" + (col - 1)).uCheck('check');
                  haveSelection = true;
                  continue;
                }
                /* 訂滿項不是已選項 */
                else
                {
                  $("#day" + i + "menu" + (col - 1)).text("訂滿了~明日請早！");
                  $("#day" + i + "menu" + (col - 1)).attr('class','am-text-default');
                  $("#day" + i + "value" + (col - 1)).attr("value","false");
                  $("#day" + i + "value" + (col - 1)).uCheck('disable');
                  continue;
                }
              }
              /* 可選且不是已選項 */
              else
              {
                $("#day" + i + "menu" + (col - 1)).html("<strong>" + menu + "(" + menuNow + "/" + menuTotal + ")" + "</strong>");
                $("#day" + i + "menu" + (col - 1)).attr('class','am-text-success am-text-lg');
                $("#day" + i + "value" + (col - 1)).attr("value",(col - 1) + menu);
                
                /* 可選且為已選項 */
                if( menu == menuSelected )
                {
                  $("#day" + i + "value" + (col - 1)).uCheck('check');
                  $("#day" + i + "menu" + (col - 1)).attr('class','am-text-warning am-text-lg');
                  haveSelection = true;
                }
              }
            }
            /* 沒有已選項時選擇不訂 */
            if( !haveSelection ) $("#day" + i + "value0").uCheck('check');
          }
          $('#menuGroup').fadeIn("slow");
          $('#btn-submitOrder').removeClass("am-disabled");
          $('#btn-submitOrder').fadeIn("slow");
        }
      
      /* 提交訂餐選項 */
        function submitOrder(){
          try{
            $(':radio').uCheck('disable');
            var $btn = $(this);
            $btn.button('loading');
            
            var orderResult = [];
            orderResult.push($("#name").text());
            for( var day = 1; day < 7; day++ )
            {
              orderResult.push($("input[name='day" + day + "ord']:checked").val());     
            }
            
            google.script.run
              .withSuccessHandler(submitSuccess)
              .withFailureHandler(submitFailed)
              .withUserObject($btn)
              .submitOrder(orderResult);
              
          }
          catch(e){
            alert(e.toString());
          }
        }
      
      /* 訂餐成功顯示信息并更新radio */
        function submitSuccess(result, $btn) {
          $("#ordresult").html("<strong>訂餐成功！</strong>");
          $("#ordresult").attr('class','am-text-center am-text-lg am-text-warning');
          $("#ordresult").fadeIn("fast");
          $("input[value!='false']").uCheck('enable');
          $btn.button('reset');
          refreshMenu();
          var $w = $(window);
          $w.smoothScroll({position: $(document).height() - $w.height()});
          
          setTimeout(function(){
            $("#ordresult").fadeOut("slow");
          }, 2000);
        }
      
      /* 訂餐失敗顯示信息并更新radio */
        function submitFailed(error, $btn) {
          $("#ordresult").text("訂餐失敗，聽我解釋T^T："+error.message);
          $("#ordresult").attr('class','am-text-center am-text-lg am-text-danger');
          $("#ordresult").fadeIn("slow");
          $("input[value!='false']").uCheck('enable');
          $btn.button('reset');
          refreshMenu();
          var $w = $(window);
          $w.smoothScroll({position: $(document).height() - $w.height()});
          
          setTimeout(function(){
            $("#ordresult").fadeOut("slow");
          }, 5000);
        }
        
      
      /* 刷新當前時間 */
        function showTime(){
          var today = new Date();
          var year = today.getFullYear(),
              month = (today.getMonth() + 1),
              day = today.getDate(),
              hours = today.getHours(),
              minutes = today.getMinutes(),
              seconds = today.getSeconds();
              
          month = checkTime(month);
          day = checkTime(day);
          minutes = checkTime(minutes);
          seconds = checkTime(seconds);
          $("#time").html("<h2>當前時間: " + year + "年" + month + "月" + day + "日 " + hours + ":" + minutes + ":" + seconds + "</h2>");
          
          t = setTimeout(function(){showTime()},1000);
        }
        
        function checkTime(i){
          if (i<10) i="0" + i;
          return i;
        }
</script>